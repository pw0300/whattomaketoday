import{g as _,p as g,a as w,k as D}from"./Dashboard-COH9xpID.js";import"./index-B3gPsghR.js";import"./firebaseService-CNi3H3Tw.js";import"./clock-DLLJtmD0.js";import"./proxy-BQHhQHVF.js";import"./share-2-CzmRxmWB.js";import"./arrow-left-2Zq-8vrk.js";import"./SEO-BJ4ChhB2.js";const b={busy_professional:{id:"busy_professional",name:"Busy Professional",description:"Quick, healthy, minimal prep time. Values efficiency.",filters:{maxCookTime:30,difficulty:"easy"},preferences:{quick:1,healthy:.8,minimal_ingredients:.7},cuisineWeights:{Mediterranean:.9,Japanese:.8,Thai:.7},avoidPatterns:["elaborate","time-intensive","multiple-steps"],sampleDishes:["Avocado Toast","Quick Stir Fry","Salad Bowl","Grilled Sandwich"]},health_enthusiast:{id:"health_enthusiast",name:"Health Enthusiast",description:"Low GI, high protein, nutrient-dense. Tracks macros.",filters:{glycemicIndex:["Low","Medium"],nutritionFocus:"high-protein"},preferences:{healthy:1,protein_rich:.9,low_carb:.7},cuisineWeights:{Mediterranean:.9,Japanese:.8,"South Indian":.6},avoidPatterns:["fried","high-sugar","processed"],sampleDishes:["Grilled Chicken Salad","Quinoa Bowl","Steamed Fish","Lentil Soup"]},traditional_cook:{id:"traditional_cook",name:"Traditional Cook",description:"Authentic recipes, time-intensive, heritage cooking.",filters:{difficulty:"any",authentic:!0},preferences:{authentic:1,traditional:.9,homestyle:.8},cuisineWeights:{"North Indian":.9,"South Indian":.9,Bengali:.8},avoidPatterns:["fusion","shortcuts","instant"],sampleDishes:["Dum Biryani","Slow-Cooked Dal","Traditional Curry","Handmade Roti"]},spice_lover:{id:"spice_lover",name:"Spice Lover",description:"High heat, bold flavors, adventurous palate.",filters:{spiceLevel:"high"},preferences:{spicy:1,bold_flavors:.9,heat:.8},cuisineWeights:{Thai:.9,Mexican:.9,Andhra:.9,Szechuan:.8},avoidPatterns:["mild","bland","subtle"],sampleDishes:["Andhra Chicken","Thai Green Curry","Chettinad Masala","Szechuan Tofu"]},family_cook:{id:"family_cook",name:"Family Cook",description:"Kid-friendly, crowd-pleasing, balanced nutrition.",filters:{kidFriendly:!0,spiceLevel:"mild"},preferences:{family_friendly:1,mild:.8,nutritious:.7},cuisineWeights:{"North Indian":.8,Italian:.8,Continental:.7},avoidPatterns:["very-spicy","exotic","unusual-textures"],sampleDishes:["Paneer Butter Masala","Pasta","Fried Rice","Dal Tadka"]},experimental_foodie:{id:"experimental_foodie",name:"Experimental Foodie",description:"Fusion, unique ingredients, culinary adventure.",filters:{novelty:"high"},preferences:{unique:1,fusion:.9,creative:.8},cuisineWeights:{Fusion:.9,Korean:.8,"Middle Eastern":.8,Peruvian:.7},avoidPatterns:["basic","common","predictable"],sampleDishes:["Korean Tacos","Butter Chicken Pizza","Sushi Burrito","Masala Mac & Cheese"]},diabetic_friendly:{id:"diabetic_friendly",name:"Diabetic-Friendly",description:"Low GI, controlled portions, blood sugar safe.",filters:{glycemicIndex:["Low"],lowSugar:!0},preferences:{low_gi:1,controlled_portions:.9,fiber_rich:.8},cuisineWeights:{Mediterranean:.9,"South Indian":.7,Japanese:.8},avoidPatterns:["high-sugar","white-rice","refined-carbs","sweet"],sampleDishes:["Cauliflower Rice Bowl","Grilled Fish","Vegetable Stir Fry","Moong Dal Cheela"]},weight_management:{id:"weight_management",name:"Weight Management",description:"Low calorie, high satiety, portion-controlled.",filters:{maxCalories:500,highSatiety:!0},preferences:{low_calorie:1,high_satiety:.9,protein_rich:.8},cuisineWeights:{Mediterranean:.9,Japanese:.9,Thai:.7},avoidPatterns:["fried","high-fat","heavy-cream","dessert"],sampleDishes:["Grilled Chicken Breast","Vegetable Soup","Salad with Protein","Steamed Dumplings"]}},v={dietaryToPersona:{Vegan:["health_enthusiast","weight_management"],Vegetarian:["traditional_cook","health_enthusiast"],"Non-Vegetarian":["spice_lover","family_cook","busy_professional"]},conditionToPersona:{Diabetes:["diabetic_friendly"],PCOS:["diabetic_friendly","weight_management"],Hypertension:["health_enthusiast","weight_management"]},cuisineToPersona:{Thai:["spice_lover","experimental_foodie"],Japanese:["health_enthusiast","busy_professional"],"North Indian":["traditional_cook","family_cook","spice_lover"],"South Indian":["traditional_cook","diabetic_friendly"],Italian:["family_cook","busy_professional"],Mediterranean:["health_enthusiast","weight_management"]}},P={personas:b,mappingRules:v};class W{constructor(){this.personaEmbeddings=new Map,this.personas=P.personas,this.mappingRules=P.mappingRules}assignPersona(s){const e=Object.keys(this.personas).map(t=>({personaId:t,score:this.calculatePersonaScore(t,s)}));e.sort((t,n)=>n.score-t.score);const i=e[0];return console.log(`[PersonaService] Assigned persona: ${i.personaId} (score: ${i.score.toFixed(2)})`),i.personaId}calculatePersonaScore(s,e){let i=0;const t=this.personas[s];if(e.conditions.forEach(r=>{const l=r;(this.mappingRules.conditionToPersona[l]||[]).includes(s)&&(i+=3)}),(this.mappingRules.dietaryToPersona[e.dietaryPreference]||[]).includes(s)&&(i+=2),e.cuisines.forEach(r=>{(this.mappingRules.cuisineToPersona[r]||[]).includes(s)&&(i+=1),t.cuisineWeights[r]&&(i+=t.cuisineWeights[r]*.5)}),e.biometrics){const{goal:r,activityLevel:l}=e.biometrics;r==="Lose"&&s==="weight_management"&&(i+=2),l==="Active"&&s==="busy_professional"&&(i+=1),l==="Moderate"&&s==="health_enthusiast"&&(i+=.5)}return i}getPersona(s){return this.personas[s]||null}getAllPersonas(){return Object.values(this.personas)}async getPersonaEmbedding(s){if(this.personaEmbeddings.has(s))return this.personaEmbeddings.get(s);const e=this.personas[s];if(!e)return null;const i=[`User Persona: ${e.name}.`,e.description,`Prefers: ${Object.keys(e.preferences).join(", ")}.`,`Cuisines: ${Object.keys(e.cuisineWeights).join(", ")}.`,`Avoids: ${e.avoidPatterns.join(", ")}.`,`Sample dishes: ${e.sampleDishes.join(", ")}.`].join(" "),t=await _(i);return t&&this.personaEmbeddings.set(s,t),t}async initializeNewUser(s,e){try{const i=this.assignPersona(e),t=this.personas[i];if(!t)throw new Error(`Persona not found: ${i}`);const n=[`User Persona: ${t.name}.`,`Dietary: ${e.dietaryPreference}.`,`Cuisines: ${e.cuisines.join(", ")||"Various"}.`,`Health: ${e.conditions.length>0?e.conditions.join(", "):"None"}.`,`Allergens: ${e.allergens.length>0?e.allergens.join(", "):"None"}.`,t.description].join(" ");return await g.upsert([{id:`user_${s}_persona`,text:n,metadata:{type:"user_persona",userId:s,personaId:i,personaName:t.name,dietaryPreference:e.dietaryPreference,conditions:e.conditions,cuisines:e.cuisines,createdAt:Date.now()}}],"users"),console.log(`[PersonaService] Initialized user ${s} with persona: ${i}`),{personaId:i,success:!0}}catch(i){return console.error("[PersonaService] Failed to initialize user:",i),{personaId:"busy_professional",success:!1}}}getSampleDishes(s){const e=this.personas[s];return(e==null?void 0:e.sampleDishes)||[]}getCuisineWeights(s){const e=this.personas[s];return(e==null?void 0:e.cuisineWeights)||{}}getAvoidPatterns(s){const e=this.personas[s];return(e==null?void 0:e.avoidPatterns)||[]}}const m=new W;class k{constructor(){this.preWarmedDishes=new Map}async generateStreamingDishes(s,e,i,t){const{userId:n,isNewUser:r}=i,l=Date.now();try{const o=Date.now();let a=[];if(n&&this.preWarmedDishes.has(n)&&(a=(this.preWarmedDishes.get(n)||[]).splice(0,Math.min(3,s)),console.log(`[Streaming] Tier 1: Served ${a.length} pre-warmed dishes`)),a.length<3){const h=3-a.length,c=await w(h,e);a=[...a,...c]}a.length>0&&t({tier:1,dishes:a,latencyMs:Date.now()-o,source:"cache"})}catch(o){console.warn("[Streaming] Tier 1 failed:",o)}try{const o=Date.now();let a=[];if(r&&n){const{personaId:c}=await m.initializeNewUser(n,e),y=m.getSampleDishes(c);for(const d of y.slice(0,3)){const u=await g.search(d,"dishes",1);if(u.length>0&&u[0].metadata){const p=u[0].metadata;p.name&&p.description&&a.push(p)}}}else{const c=`${e.cuisines.join(" ")} ${e.dietaryPreference} dishes`;a=(await g.search(c,"dishes",5)).filter(d=>d.score&&d.score>.8).map(d=>d.metadata).filter(d=>d&&d.name)}const h=new Set((await w(10,e)).map(c=>c.name));a=a.filter(c=>!h.has(c.name)),a.length>0&&t({tier:2,dishes:a.slice(0,s),latencyMs:Date.now()-o,source:"persona+vector"})}catch(o){console.warn("[Streaming] Tier 2 failed:",o)}console.log(`[Streaming] Tiers 1-2 complete in ${Date.now()-l}ms. Tier 3 ready.`)}setPreWarmedDishes(s,e){this.preWarmedDishes.set(s,e),console.log(`[Streaming] Stored ${e.length} pre-warmed dishes for user ${s}`)}hasPreWarmedDishes(s){const e=this.preWarmedDishes.get(s);return e!==void 0&&e.length>0}getPreWarmedCount(s){var e;return((e=this.preWarmedDishes.get(s))==null?void 0:e.length)||0}clearPreWarmedDishes(s){this.preWarmedDishes.delete(s)}async getInstantRecommendations(s,e=3){return D.suggestDishes({dietaryPreference:s.dietaryPreference,allergens:s.allergens,cuisines:s.cuisines}).slice(0,e).map((n,r)=>({id:`instant-${Date.now()}-${r}`,name:n.displayName,localName:n.displayName,description:`Traditional ${n.cuisine} dish`,cuisine:n.cuisine,type:"Dinner",image:"",macros:{calories:300,protein:15,carbs:40,fat:10},ingredients:[],instructions:[],tags:n.dietaryTags,allergens:[],matchScore:80}))}}const S=new k;class T{constructor(){this.preWarmStatus=new Map,this.preWarmQueue=new Set}async startPreWarming(s,e){if(this.preWarmQueue.has(s)){console.log(`[PreWarm] User ${s} already in queue, skipping.`);return}this.preWarmQueue.add(s),this.preWarmStatus.set(s,{userId:s,startedAt:Date.now(),completedAt:null,dishCount:0,status:"in_progress"}),console.log(`[PreWarm] Starting background generation for user ${s}...`);try{const i=m.assignPersona(e),t=m.getPersona(i);if(!t)throw new Error(`Persona not found: ${i}`);const n=D.suggestDishes({dietaryPreference:e.dietaryPreference,allergens:e.allergens,cuisines:e.cuisines}),r=[];for(const a of n.slice(0,8)){const h={id:`prewarm-kg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:a.displayName,localName:a.displayName,description:`Traditional ${a.cuisine} dish - ${e.dietaryPreference}`,cuisine:a.cuisine,type:this.inferMealType(a.displayName),image:"",macros:this.estimateMacros(a),ingredients:[],instructions:[],tags:a.dietaryTags,healthTags:this.generateHealthTags(e,a),allergens:[],matchScore:85+Math.floor(Math.random()*10),generatedAt:Date.now()};r.push(h)}const l=t.sampleDishes||[];for(const a of l.slice(0,4)){const h={id:`prewarm-persona-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:a,localName:a,description:`${t.name} style - ${t.description}`,cuisine:Object.keys(t.cuisineWeights)[0]||"Fusion",type:"Dinner",image:"",macros:{calories:350,protein:20,carbs:35,fat:12},ingredients:[],instructions:[],tags:Object.keys(t.preferences).map(c=>c.replace("_"," ")),healthTags:[],allergens:[],matchScore:90,generatedAt:Date.now()};r.push(h)}S.setPreWarmedDishes(s,r);const o=this.preWarmStatus.get(s);o&&(o.completedAt=Date.now(),o.dishCount=r.length,o.status="complete"),console.log(`[PreWarm] Complete for user ${s}: ${r.length} dishes in ${Date.now()-((o==null?void 0:o.startedAt)||Date.now())}ms`)}catch(i){console.error(`[PreWarm] Failed for user ${s}:`,i);const t=this.preWarmStatus.get(s);t&&(t.status="failed")}finally{this.preWarmQueue.delete(s)}}isPreWarmComplete(s){const e=this.preWarmStatus.get(s);return(e==null?void 0:e.status)==="complete"}getStatus(s){return this.preWarmStatus.get(s)||null}getPreWarmedDishes(s){return S.getPreWarmedCount(s)}inferMealType(s){const e=s.toLowerCase();return e.includes("breakfast")||e.includes("toast")||e.includes("paratha")||e.includes("poha")||e.includes("idli")||e.includes("dosa")?"Breakfast":e.includes("snack")||e.includes("pakora")||e.includes("chaat")||e.includes("samosa")?"Snack":e.includes("rice")||e.includes("thali")||e.includes("dal")?"Lunch":"Dinner"}estimateMacros(s){var i,t;const e={calories:300,protein:15,carbs:40,fat:10};return(i=s.dietaryTags)!=null&&i.includes("Vegetarian")&&(e.protein-=5),(t=s.dietaryTags)!=null&&t.includes("Non-Vegetarian")&&(e.protein+=10),e}generateHealthTags(s,e){const i=[];return s.conditions.includes("Diabetes")&&i.push("Diabetes-Friendly"),s.conditions.includes("PCOS")&&i.push("PCOS-Safe"),s.dietaryPreference==="Vegan"&&i.push("Plant-Based"),i}}const E=new T;export{E as preWarmService};
